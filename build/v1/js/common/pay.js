define(["jquery","clib/modal","common/utils"],function(t,i,n){var o={urls:{pay_order:"http://backend.star.kankan.com/user_order?jsoncallback=?&",pay_submit:"http://busi.vip.kankan.com/pay/submit?",pay_verifyOrder:"http://busi.vip.kankan.com/pay/verifyOrder?rand=",dialog:"/pay_dialog.html"},payDesc:"",payEndBtnText:"确定",payInfo:{type:"",amount:{1:"2000",3:"4500",12:"18000"},bizNo:"000001032",handler:"CXKJ",refId:"fref_%252Ccxkj%253B%253B",payAmount:"12",payType:"E"},success:function(){},fail:function(){}},a=n.cookie,e="",s=function(i){return this.doneList=[],this.failList=[],this.state="pending",t.isFunction(i)&&(i=new i),t.extend(i,this),i};s.prototype={constructor:"Promise",resolve:function(){this.state="resolved";for(var t=this.doneList,i=0,n=t.length;n>i;i++)t[i].call(this)},reject:function(){this.state="rejected";for(var t=this.failList,i=0,n=t.length;n>i;i++)t[i].call(this)},done:function(t){return"function"==typeof t&&this.doneList.push(t),this},fail:function(t){return"function"==typeof t&&this.failList.push(t),this},always:function(t){return this.done(t).fail(t),this}};var d=function(i){this.options=t.extend(!0,{},o,i);var n=this.options.payInfo;if(!n.amount[n.payAmount])throw"error";this.options.dialog&&(this.setDialog(this.options.dialog),this.$dialog.data("pay",this),l.init(this.$dialog))};d.prototype.setDialog=function(i){this.$dialog=t(i)},d.prototype.resetDialog=function(){},d.prototype.openDialog=function(){var t=this;return t.$dialog?void t.$dialog.modal("open"):void(t.options.urls.dialog&&n.loadHtml(t.options.urls.dialog,function(i){t.setDialog(i),i.data("pay",t),l.init(i),t.openDialog()}))},d.prototype.closeDialog=function(){var t=this;t.$dialog&&(t.$dialog.modal("close"),t.resetDialog())};var c=new s(function(){var i=this,o=!1,s=null;this.init=function(a){function d(){s.find("#desc").children("span").text(p).parent("dt").siblings("dd").find(".totalCount").text(r.amount[r.payAmount]/100+"元")}var c=a.options.urls,r=a.options.payInfo,p=a.options.payDesc;s=a.$dialog.find("#quickPayBox"),"hit"==r.type&&s.find(".js_numFlower").show().on("click","dd input[type=radio]",function(){t(this).attr("checked",!0).parent("dd").addClass("on").siblings("dd").removeClass("on"),r.payAmount=t(this).parent("dd").attr("data")}).find("dd[data="+r.payAmount+"] input[type=radio]").click(),s.find(".js_payType").on("click","dd input[type=radio]",function(){var i=t(this).parent("dd");i.addClass("on").siblings("dd").removeClass("on"),"B2"==i.attr("data")?s.find(".js_bankList").show().find("dd a.choseBank").on("click",function(){t(this).siblings("ul").show()}).siblings("ul").find("a").on("click",function(){var i=t(this).text();t(this).parents("ul").hide().siblings("a").html(i+"<b></b>").attr("data",t(this).attr("data"))}):s.find(".js_bankList").hide().find("ul").hide(),r.payType=t(this).parent().attr("data")}).find("dd[data="+r.payType+"] input[type=radio]").click(),n.watch.add(function(){return r.payAmount},d),d(),s.find(".pay_btn a").on("click",function(){return o?!1:(o=!0,void t.getJSON(c.pay_order+"type="+r.type,function(n){if(200==n.status&&n.data&&n.data.randid){var a={type:r.type,month:r.payAmount,needAmount:r.amount[r.payAmount],bizNo:r.bizNo,handler:r.handler,refId:r.refId,payType:r.payType};"B2"==a.payType&&(a.bankNo=s.find(".js_bankList .choseBank").attr("data").toUpperCase()),e=a.rand=n.data.randid,window.open(c.pay_submit+t.param(a)),o=!1,i.resolve()}else alert("访问出错，请刷新")}))}),s.find(".pay_top a").on("click",function(){i.reject()})},this.show=function(){s.show().find("#quickPayNickid").text(a.get("userid")).siblings("#quickPayNickname").text("("+a.get("usernick")+")")},this.hide=function(){s.hide()}}),r=new s(function(){var i=this,n='<b class="ico_exclamation"></b><p style="padding-left:94px;"><strong>请您在新打开的页面上完成付款</strong></p><p style="padding-left:94px;font-size:12px;">支付完成前请不要关闭窗口</p><p style="padding-left:94px;font-size:12px;">支付完成后请根据结果选择</p>',o='<p style="text-align:center;"><strong>支付还未成功</strong></p><p style="text-align:center;">您的支付过程还没有完成</p><p style="text-align:center;">可能是由于系统延迟，请稍后查询</p>',a=null;this.init=function(s){function d(i){var n=t.Deferred();return t.ajax({dataType:"jsonp",url:c.pay_verifyOrder+i,type:"get",success:function(t){0==t.rtn&&1==t.data.paid?n.resolve():n.reject()},error:function(){n.reject()}}),n.promise()}var c=s.options.urls;a=s.$dialog.find("#quickCheckBox");var r;a.find(".pay_btn a.query").click(function(){r=this,t.when(d(e)).done(function(){i.resolve()}).fail(function(){a.find(".pay_content").html(o),t(r).text("再试一次")})}),a.find('.pay_btn a[title="取消"], #quickCheckBoxTitle a').click(function(){a.find(".pay_content").html(n),t(r).text("支付成功"),i.reject()})},this.show=function(){a.show()},this.hide=function(){a.hide()}}),p=new s(function(){var t=this,i=null;this.init=function(n){i=n.$dialog.find("#quickPayOkbox"),i.find(".pay_btn a").click(function(){t.resolve()}).text(n.options.payEndBtnText)},this.show=function(){i.show()},this.hide=function(){i.hide()}}),l={init:function(i){var n=i.data("pay");c.init(n),r.init(n),p.init(n),c.show(),c.always(function(){c.hide()}).done(function(){r.show()}).fail(function(){n.closeDialog(),t.isFunction(n.options.fail)&&n.options.fail()}),r.always(function(){r.hide()}).done(function(){p.show()}).fail(function(){n.closeDialog(),t.isFunction(n.options.fail)&&n.options.fail()}),p.always(function(){n.closeDialog(),t.isFunction(n.options.success)&&n.options.success()})}};return d});
//# sourceMappingURL=../../maps/js/common/pay.js.map
//# sourceMappingURL=../../maps/js/common/pay.js.map
//# sourceMappingURL=../../js/maps/js/common/pay.js.map